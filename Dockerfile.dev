FROM php:8.3-fpm

# Install dependencies
RUN apt-get update && apt-get install -y \
    git \
    unzip \
    cron \
    wget \
    libcurl4-openssl-dev \
    libpng-dev \
    libjpeg62-turbo-dev \
    libfreetype6-dev \
    libxml2-dev \
    libonig-dev \
    libssl-dev \
    pkg-config \
    && docker-php-ext-configure gd \
        --with-freetype \
        --with-jpeg \
    && docker-php-ext-install \
        mysqli \
        gd \
        bcmath \
        xml \
        dom \
        mbstring \
        pdo_mysql \
        curl \
        dba \
        zip \
        sockets \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*

# Install Composer
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Set working directory
WORKDIR /var/www/html

# Create startup script that handles mounted volumes
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "Starting ARGUS Guard Service..."\n\
\n\
# Create application log files with proper permissions\n\
touch /var/log/ip-blocklist.log\n\
\n\
# Set proper permissions for log files\n\
chmod 666 /var/log/ip-blocklist.log\n\
\n\
# Create nginx log files with proper permissions\n\
touch /var/log/nginx/argus_access.log\n\
touch /var/log/nginx/argus_error.log\n\
touch /var/log/argus_tip.log\n\
chmod 666 /var/log/nginx/*.log\n\
chown www-data:www-data /var/log/nginx/*.log\n\
\n\
# Install/update composer dependencies if needed\n\
if [ -f "/var/www/html/composer.json" ]; then\n\
    echo "Installing/updating composer dependencies..."\n\
    composer install --no-dev --optimize-autoloader\n\
fi\n\
\n\
# Set up cron if cron file exists\n\
if [ -f "/var/www/html/cron/blocklist-cron" ]; then\n\
    echo "Setting up cron jobs..."\n\
    cp /var/www/html/cron/blocklist-cron /etc/cron.d/blocklist-cron\n\
    chmod 0644 /etc/cron.d/blocklist-cron\n\
    crontab /etc/cron.d/blocklist-cron\n\
fi\n\
\n\
# Set proper ownership for web files\n\
chown -R www-data:www-data /var/www/html\n\
chmod -R 755 /var/www/html\n\
\n\
# Set log file ownership (but preserve permissions for writes)\n\
chown www-data:www-data /var/log/ip-blocklist.log\n\
\n\
# Generate FireHOL blocklist if not exist\n\
echo "Generate FireHOL blocklist."\n\
if [ ! -f "/var/www/html/blocklist/argus-ipsets.cdb" ]; then\n\
    /bin/bash /var/www/html/script/argus-blocklist.sh\n\
fi\n\
\n\
echo "ARGUS Guard service initialization completed."\n\
\n\
# Start services\n\
echo "Starting cron daemon..."\n\
cron\n\
\n\
echo "Starting PHP-FPM..."\n\
exec php-fpm\n\
' > /usr/local/bin/start.sh && chmod +x /usr/local/bin/start.sh

CMD ["/usr/local/bin/start.sh"]